<ng-container *ngIf="!listLoading; else loadingCourses">
	<section class="take-course-wrapper" *ngIf="courses.length; else noCourses">
		<aside class="selector-pane">
			<header class="selector-header">
				<div>
					<p class="selector-kicker">Tus cursos</p>
					<h2>Biblioteca de formaci√≥n</h2>
				</div>
				<span class="role-pill" *ngIf="role">Rol {{ role }}</span>
			</header>

			<label class="search-box">
				<input
					type="search"
					name="courseSearch"
					placeholder="Buscar por t√≠tulo, idioma o nivel"
					[ngModel]="searchTerm"
					(ngModelChange)="applyFilter($event)"
				/>
				<span class="icon">üîç</span>
			</label>

			<p class="inline-error" *ngIf="listError">{{ listError }}</p>

			<div class="course-pills" *ngIf="filteredCourses.length; else emptyFilter">
				<button
					class="course-pill"
					type="button"
					*ngFor="let course of filteredCourses; trackBy: trackByCourse"
					(click)="selectCourse(course.id)"
					[class.active]="isCourseActive(course.id)"
				>
					<div class="pill-head">
						<span class="pill-title">{{ course.title }}</span>
						<span class="status-chip" [class.published]="course.status === 'PUBLISHED'">
							{{ course.status | titlecase }}
						</span>
					</div>
					<p class="pill-description">{{ course.description }}</p>
					<div class="pill-meta">
						<span>{{ course.level | titlecase }}</span>
						<span>{{ course.language }}</span>
						<span>{{ formatDate(course.publicationDate || course.creationDate) }}</span>
					</div>
				</button>
			</div>

			<ng-template #emptyFilter>
				<div class="empty-state">
					<p>No encontramos cursos que coincidan con "{{ searchTerm }}".</p>
					<button type="button" class="btn ghost" (click)="applyFilter('')">Limpiar b√∫squeda</button>
				</div>
			</ng-template>
		</aside>

		<section class="content-pane" *ngIf="selectedCourse as course; else selectCourseMessage">
			<div class="hero-card">
				<ng-container *ngIf="previewLesson() as preview">
					<div class="hero-media">
						<ng-container *ngIf="previewUrl(preview) as safeUrl; else fallbackImage">
							<iframe [src]="safeUrl" title="Vista previa" allowfullscreen loading="lazy"></iframe>
						</ng-container>
						<ng-template #fallbackImage>
							<img [src]="safeImage(course.image)" [alt]="course.title" />
							<button *ngIf="preview.contentUrl" type="button" class="plain-link" (click)="openLesson(preview)">
								Abrir recurso de vista previa
							</button>
						</ng-template>
					</div>
				</ng-container>

				<div class="hero-info">
					<p class="breadcrumb">GastroGuide ¬∑ Cursos ¬∑ {{ course.title }}</p>
					<h1>{{ course.title }}</h1>
					<p class="hero-description">{{ course.description }}</p>
					<div class="hero-meta">
						<span *ngIf="course.averageRating">
							<strong>{{ course.averageRating | number:'1.1-1' }}</strong>
							({{ course.totalReviews || 0 }} rese√±as)
						</span>
						<span>{{ course.totalStudents || 0 }} estudiantes</span>
						<span>{{ lessonsCount(course) }} lecciones</span>
						<span>{{ formatDuration(course.totalDuration) }}</span>
						<span>{{ course.language }}</span>
					</div>
					<div class="hero-tags">
						<span class="chip">{{ course.level | titlecase }}</span>
						<span class="chip" [class.published]="course.status === 'PUBLISHED'">
							{{ course.status | titlecase }}
						</span>
						<span class="chip" *ngIf="course.publicationDate">
							Actualizado {{ formatDate(course.publicationDate) }}
						</span>
					</div>
					<div class="price-row" *ngIf="course.price || course.discountPrice">
						<span class="price-current">
							{{ (course.discountPrice ?? course.price) | currency:'USD':'symbol':'1.0-0' }}
						</span>
						<span class="price-old" *ngIf="course.discountPrice">
							{{ course.price | currency:'USD':'symbol':'1.0-0' }}
						</span>
					</div>
					<div class="hero-actions">
						<button class="btn primary" type="button" (click)="scrollToCurriculum()">Continuar curso</button>
						<button class="btn secondary" type="button" (click)="scrollToCurriculum()">Ver contenido</button>
					</div>
				</div>
			</div>

			<p class="inline-error" *ngIf="detailError">{{ detailError }}</p>
			<div class="content-grid" id="curriculum">
				<section class="curriculum" *ngIf="course.modules.length; else noModules">
					<header>
						<div>
							<h2>Contenido del curso</h2>
							<p>{{ course.modules.length }} secciones ¬∑ {{ lessonsCount(course) }} lecciones</p>
						</div>
						<span class="last-update">
							√öltima actualizaci√≥n {{ formatDate(course.publicationDate || course.creationDate) }}
						</span>
					</header>

					<article class="module-card" *ngFor="let module of course.modules; trackBy: trackByModule">
						<button class="module-header" type="button" (click)="toggleModule(module.id)">
							<div>
								<p>{{ module.title }}</p>
								<small>{{ module.lessons.length }} lecciones ¬∑ {{ formatDuration(moduleDuration(module)) }}</small>
							</div>
							<span class="module-chip" *ngIf="module.locked">Bloqueado</span>
							<span class="chevron">{{ isModuleExpanded(module.id) ? '‚ñæ' : '‚ñ∏' }}</span>
						</button>

						<div class="lessons" *ngIf="isModuleExpanded(module.id)">
							<article class="lesson-row" *ngFor="let lesson of module.lessons; trackBy: trackByLesson">
								<div class="lesson-main">
									<span class="lesson-badge" [class.video]="lesson.contentType === 'VIDEO'">
										{{ lessonTag(lesson) }}
									</span>
									<div>
										<p class="lesson-title">{{ lesson.order }}. {{ lesson.title }}</p>
										<p class="lesson-description">{{ lesson.description }}</p>
									</div>
								</div>
								<div class="lesson-meta">
									<span class="lesson-duration">
										{{ lesson.duration ? (lesson.duration + ' min') : '‚Äî' }}
									</span>
									<button
										class="lesson-action"
										type="button"
										(click)="openLesson(lesson)"
										[disabled]="lesson.locked && role === 'STUDENT'"
									>
										{{ lesson.locked && role === 'STUDENT' ? 'Bloqueada' : 'Ver' }}
									</button>
								</div>
							</article>
						</div>
					</article>
				</section>

				<ng-template #noModules>
					<div class="empty-state">
						<h3>Pendiente de contenido</h3>
						<p>Este curso a√∫n no tiene m√≥dulos publicados.</p>
					</div>
				</ng-template>

				<aside class="course-sidebar">
					<div class="info-card">
						<h3>Instructor</h3>
						<p>{{ course.creatorName || 'Equipo GastroGuide' }}</p>
						<p class="subtle">Idioma: {{ course.language }} ¬∑ Nivel: {{ course.level | titlecase }}</p>
					</div>

					<div class="info-card" *ngIf="course.objectives.length">
						<h3>Lo que aprender√°s</h3>
						<ul>
							<li *ngFor="let objective of course.objectives">{{ objective }}</li>
						</ul>
					</div>

					<div class="info-card" *ngIf="course.requirements.length">
						<h3>Requisitos</h3>
						<ul>
							<li *ngFor="let requirement of course.requirements">{{ requirement }}</li>
						</ul>
					</div>

					<div class="info-card" *ngIf="course.tags.length">
						<h3>Etiquetas</h3>
						<div class="tags">
							<span class="chip" *ngFor="let tag of course.tags">{{ tag }}</span>
						</div>
					</div>

					<div class="info-card" *ngIf="course.certificates.length">
						<h3>Certificados</h3>
						<p>{{ course.certificates.join(', ') }}</p>
					</div>
				</aside>
			</div>
		</section>
	</section>
</ng-container>

<ng-template #loadingCourses>
	<div class="loading-state">
		<div class="spinner"></div>
		<p>Cargando cursos disponibles...</p>
	</div>
</ng-template>

<ng-template #noCourses>
	<div class="empty-state global">
		<h3>No hay cursos disponibles</h3>
		<p>Los creadores todav√≠a no han publicado cursos para tu rol.</p>
	</div>
</ng-template>

<ng-template #selectCourseMessage>
	<div class="empty-state">
		<h3>Selecciona un curso</h3>
		<p>Elige un curso de la lista izquierda para ver sus m√≥dulos y lecciones.</p>
	</div>
</ng-template>
